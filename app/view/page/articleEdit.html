{% extends 'template/jhTemplateV4.html'%}

{% block vueTemplate %}

<script type="text/html" id="app-template">
<div>
<v-app mobile-breakpoint="sm">
  <jh-menu />
  <v-main class="mt-15">
    <!-- 头部内容 >>>>>>>>>>>>> -->
    <div class="jh-page-second-bar px-8">
      <v-row>
        <v-col cols="12" xs="12" sm="12" md="4" xl="3">
          <div class="pt-3 text-h7 font-weight-bold">文章编辑
            <!-- 帮助页按钮 -->
            <v-icon @click="isHelpPageDrawerShown = true" color="success" small>mdi-help-circle-outline
            </v-icon>
          </div>
          <v-breadcrumbs class="pb-3 pt-0 pl-0" :items="breadcrumbs" divider="-"></v-breadcrumbs>
        </v-col>
        <!-- 操作按钮组 -->
        <v-col cols="12" xs="12" sm="12" md="8" xl="9">
          <v-row class="jh-backend-form-container justify-end ma-0 py-1 pb-xs-2 mt-3">
            <v-btn v-if="editItem.articleId && editItem.articlePublishStatus !== 'deleted'"
                @click="doUiAction('deleteArticle') " color="error mr-1" depressed small>
                <v-icon class="mr-1" small>mdi-trash-can</v-icon>
                <$ constantUiMap.common.moveToRecycleBin $>
            </v-btn>
            <v-btn v-if="editItem.articlePublishStatus === 'deleted'" @click="doUiAction('restoreArticle') " color="error mr-1"
                depressed small>
                <v-icon class="mr-1" small>mdi-backburger</v-icon>
                <$ constantUiMap.article.recoverArticle $>
            </v-btn>
            <v-btn @click="doUiAction('saveInfo')" color="success" class="mr-1" depressed small>
                <v-icon class="mr-1" small>mdi-content-save-all</v-icon>
                <$ constantUiMap.common.save $>
            </v-btn>
            <v-btn @click="doUiAction('saveInfoAndPreview') " color="success" depressed small>
                <v-icon class="mr-1" small>mdi-eye-refresh</v-icon>
                <$ constantUiMap.common.saveAndPreview $>
            </v-btn>
          </v-row>
        </v-col>
      </v-row>
    </div>
    <!-- <<<<<<<<<<<<< 头部内容 -->

    <!-- 页面内容 >>>>>>>>>>>>> -->
    <div class="jh-page-body-container px-8">
      <!-- 页面主要内容 -->
      <v-container class="fullScreen d-flex flex-column pa-xs-0 pa-0">
        <v-card style="min-height: calc(100vh - 126px);background-color: #f5f8fa;">
            <v-form ref="articleForm">
                <div class="d-flex flex-column">
                    <v-row dense no-gutters>
                        <!-- 左边栏 -->
                        <v-col cols="12" xs="12" sm="4" md="3" xl="2" class="pr-sm-2">
                            <v-card flat style="padding: 16px !important;">
                                <v-toolbar flat dense>
                                    <p class="font-weight-medium mb-0" style="font-size: 14px;">
                                        基本信息
                                    </p>
                                </v-toolbar>
                                <v-card-text class="px-0">
                                    <span class="inputLabel">
                                        <$ constantUiMap.article.articleTitle $>
                                    </span>
                                    <v-text-field single-line dense filled color="success"
                                        label="<$ constantUiMap.article.articleTitle $>" v-model="editItem.articleTitle"
                                        :rules="validationRules.requireRules" hide-details>
                                    </v-text-field>
                                </v-card-text>
                            </v-card>
        
                            <v-card class="mt-2" flat style="padding: 16px !important;">
                                <v-toolbar flat dense>
                                    <p class="font-weight-medium mb-0" style="font-size: 14px;">
                                        封面
                                    </p>
                                    <v-spacer></v-spacer>
                                    <v-btn outlined small fab style="width: 20px;height:20px"
                                        @click="doUiAction('imagePicker') ">
                                        <v-icon small>mdi-upload-outline</v-icon>
                                    </v-btn>
                                    <v-btn outlined small fab class="ml-2" color="error" style="width: 20px;height:20px"
                                        @click.stop="doUiAction('clearImage') " v-if="editItem.articleCoverImage">
                                        <v-icon small>mdi-trash-can-outline</v-icon>
                                    </v-btn>
                                </v-toolbar>
                                <v-card-text class="pa-0 text-center">
                                    <img v-if="editItem.articleCoverImage" :src="upload + editItem.articleCoverImage" alt=""
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                    <p v-else class="text-center">暂无封面~</p>
                                </v-card-text>
                            </v-card>

                            <v-card class="mt-2" flat style="padding: 16px !important;">
                                <v-toolbar flat dense>
                                    <p class="font-weight-medium mb-0" style="font-size: 14px;">
                                        音频
                                    </p>
                                    <v-spacer></v-spacer>
                                    <v-btn outlined small fab style="width: 20px;height:20px"
                                        @click="doUiAction('audioPicker')">
                                        <v-icon small>mdi-upload-outline</v-icon>
                                    </v-btn>
                                    <v-btn outlined small fab class="ml-2" color="error" style="width: 20px;height:20px"
                                        @click.stop="doUiAction('clearAudio') " v-if="editItem.articleAudioUrl">
                                        <v-icon small>mdi-trash-can-outline</v-icon>
                                    </v-btn>
                                </v-toolbar>
                                <v-card-text class="px-0 text-center">
                                    <audio style="max-width: 100%;" v-if="editItem.articleAudioUrl"
                                        :src="`/<$ ctx.app.config.appId $>/upload/${editItem.articleAudioUrl}?v=${new Date().getTime()}`"
                                        controls>
                                        <source
                                            :src="`/<$ ctx.app.config.appId $>/upload/${editItem.articleAudioUrl}?v=${new Date().getTime()}`"
                                            type="audio/mpeg">
                                    </audio>
                                    <p v-else class="text-center">暂无音频~</p>
                                </v-card-text>
                            </v-card>
        
                            <v-card class="mt-2" flat style="padding: 16px !important;">
                                <v-toolbar flat dense>
                                    <p class="font-weight-medium mb-0" style="font-size: 14px;">
                                        视频
                                    </p>
                                    <v-spacer></v-spacer>
                                    <v-btn outlined small fab style="width: 20px;height:20px"
                                        @click="doUiAction('videoPicker') ">
                                        <v-icon small>mdi-upload-outline</v-icon>
                                    </v-btn>
                                    <v-btn outlined small fab class="ml-2" color="error" style="width: 20px;height:20px"
                                        @click.stop="doUiAction('clearVideo') " v-if="editItem.articleVideoUrl">
                                        <v-icon small>mdi-trash-can-outline</v-icon>
                                    </v-btn>
                                </v-toolbar>
                                <v-card-text class="px-0">
                                    <video style="max-width: 100%;" v-if="editItem.articleVideoUrl"
                                        :src="`/<$ ctx.app.config.appId $>/upload/${editItem.articleVideoUrl}?v=${new Date().getTime()}`"
                                        controls>
                                        <source
                                            :src="`/<$ ctx.app.config.appId $>/upload/${editItem.articleVideoUrl}?v=${new Date().getTime()}`"
                                            type="video/mp4">
                                    </video>
                                    <p v-else class="text-center">暂无视频~</p>
                                </v-card-text>
                            </v-card>
                        </v-col>
                        <!-- markdown编辑 -->
                        <v-col cols="12" xs="12" sm="8" md="9" xl="10" class="mt-2 mt-sm-0">
                            <v-card flat style="height: 98.5%;" >
                                <div id="editorMdContainer">
                                    <textarea style="display:none;">{{ editItem.articleContent }}</textarea>
                                </div>
                            </v-card>
                        </v-col>
                    </v-row>
                </div>
            </v-form>
        </v-card>
      </v-container>

      <!-- 选择素材弹窗 -->
      <v-dialog v-model="isFileDialogShown" hide-overlay fullscreen transition="dialog-bottom-transition">
        <v-card>
            <v-toolbar dark width="100%" style="background-color: #fff;">
                <div class="black--text ml-2 font-weight-medium" style="font-size: 14px;">选择素材</div>
                <v-spacer></v-spacer>
                <v-toolbar-items>
                    <v-btn text @click="doUiAction('closeMaterialPicker')">
                        <v-icon class="black--text">mdi-close</v-icon>
                    </v-btn>
                </v-toolbar-items>
            </v-toolbar>
            <v-divider style="border-color: #eff2f5;opacity:0.8;"></v-divider>
            <file-browser v-if="isFileDialogShown" v-on:use-material="useMaterial"
                v-on:close-material-picker="closeMaterialPicker" :material-type="materialType">
            </file-browser>
        </v-card>
      </v-dialog>
    </div>
    <!-- <<<<<<<<<<<<< 页面内容 -->

    <!-- 帮助页抽屉 >>>>>>>>>>>>> -->
    <v-navigation-drawer v-model="isHelpPageDrawerShown" v-click-outside="drawerClickOutside" fixed temporary right width="80%" class="elevation-24">
      <iframe
        style="border: 0" :src="`/${appInfo.appId}/pageDoc#2.articleEdit.md`" width="100%"
        height="100%"></iframe>

      <v-btn
        elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn"
        @click="isHelpPageDrawerShown = false">
        <v-icon>mdi-close</v-icon>
      </v-btn>
    </v-navigation-drawer>
    <!-- <<<<<<<<<<<<< 帮助页抽屉 -->

  </v-main>
</v-app>

<jh-toast />
<jh-mask />
<jh-confirm-dialog />

</div>
</script>

<div id="app">
</div>

{% endblock %}

{% block vueScript %}

<!-- 加载页面组件 >>>>>>>>>>>>> -->
{% include 'common/jianghuJs/fixedTableHeightV4.html' %}
{% include 'component/fileBrowser/FileBrowser.html' %}
{% include 'component/articleEditor/articleEditorCss.html' %}
<!-- <<<<<<<<<<<<< 加载页面组件 -->

<!-- 加载页面静态资源 >>>>>>>>>>>>> -->
<link rel="stylesheet" href="/<$ ctx.app.config.appId $>/public/plugins/editor.md/css/editormd.min.css" />
<link href="/<$ ctx.app.config.appId $>/public/articleViewer/font-awesome.min.css?v=6.0.0" />
<script src="/<$ ctx.app.config.appId $>/public/js/lib/jquery.min.js"></script>
<script src="/<$ ctx.app.config.appId $>/public/plugins/editor.md/editormd.js"></script>
<!-- <<<<<<<<<<<<< 加载页面静态资源 -->

<script type="module">
new Vue({
  el: '#app',
  template: '#app-template',
  vueComponent: 'page',
  vuetify: new Vuetify(),
  data: {
    // 面包屑
    breadcrumbs: [
      {
        text: '首页',
        disabled: true,
      },
      {
        text: '文章编辑',
        disabled: true,
      }
    ],
    isHelpPageDrawerShown: false,

    // 下拉选项
    constantObj: {
      category: [],
      articleTagList: [],
      articlePublishStatus: [
        { text: "公开", value: "public" },
        { text: "登录可见", value: "login" },
        { text: "草稿", value: "draft" },
        { text: "回收站", value: "deleted" },
      ],
      categoryList: [
        { text: "全部类目", value: "all" },
      ],
    },

    // 表单相关数据
    validationRules: {
      requireRules: [
        v => !!v || 'This is required',
      ],
    },

    //文章相关
    newArticleId: null,
    articleId: null,
    upload: window.appInfo.upload,
    localImage: null,
    localAudio: null,
    localVideo: null,
    editItem: {
      articlePublishStatus: 'public'
    },
    computedEditItem: {},

    search: '',
    materialType: '',
    writeBackType: '',
    editor: null,
    mdChanged: false,
    toolbarIcons: [
      "undo", "redo", "|",
      "watch",
      "preview", "|",
      "h1", "h2", "h3", "h4", "h5", "bold", "del", "italic", "quote", "mark",
      "imageUpload", "audioUpload", "videoUpload", "attachmentUpload",
      "list-ul", "list-ol", "hr", "link", "|",
      "toggle", "articleQuery"
    ],

    isFileDialogShown: false,
  },
  watch: {
    editItem(val){
      this.computedEditItem = val;
    }
  },
  async created() {
    await this.doUiAction('prepareData');
  },
  async mounted() {
    await this.doUiAction('getData');
    await this.doUiAction('initEditorMd');
    await this.doUiAction('beforeUnloadCheckMDChange');
  },
  methods: {
    async doUiAction(uiActionId, uiActionData) {
      switch (uiActionId) {
        case 'prepareData':
          await this.getUrlObj();
          break;
        case 'getData':
          await this.getArticleData();
          break;
        case 'initEditorMd':
          await this.initEditorMd();
          break;
        case 'beforeUnloadCheckMDChange':
          await this.beforeUnloadCheckMDChange();
          break;
        case 'deleteArticle':
          await this.confirmDeleteItemDialog();
          await this.doDeleteItem();
          await this.getArticleData();
          break;
        case 'restoreArticle':
          await this.confirmRestoreItemDialog();
          await this.doRestoreItem();
          await this.getArticleData();
          break;
        case 'saveInfo':
          await this.saveInfo(uiActionData);
          break;
        case 'saveInfoAndPreview':
          await this.saveInfoAndPreview(uiActionData);
          break;
        case 'insertItem':
          await this.prepareFormValidate(uiActionData);
          await this.insertItem(uiActionData);
          await this.mdChangedFalse(uiActionData);
          await this.getNewArticle(uiActionData);
          await this.getArticleData(uiActionData);
          await this.refreshPage(uiActionData);
          break;
        case 'updateItem':
          await this.prepareFormValidate(uiActionData);
          await this.updateItem(uiActionData);
          await this.mdChangedFalse(uiActionData);
          await this.getArticleData(uiActionData);
          await this.refreshPage(uiActionData);
          break;
        case 'imagePicker':
          await this.prepareValidate(uiActionData);
          await this.imagePicker(uiActionData);
          break;
        case 'clearImage':
          await this.clearImage(uiActionData);
          break;
        case 'audioPicker':
          await this.prepareValidate(uiActionData);
          await this.audioPicker(uiActionData);
          break;
        case 'clearAudio':
          await this.clearAudio(uiActionData);
          break;
        case 'videoPicker':
          await this.prepareValidate(uiActionData);
          await this.videoPicker(uiActionData);
          break;
        case 'clearVideo':
          await this.clearVideo(uiActionData);
          break;
        case 'closeMaterialPicker':
          await this.closeMaterialPicker(uiActionData);
          break;
        default:
          console.error("[doUiAction] uiActionId not find", { uiActionId });
          break;
      }
    },

    // ---------- 文章未保存离开时提示 uiAction >>>>>>>>>> --------
    async beforeUnloadCheckMDChange(){
      const that = this;
      window.onbeforeunload = function () {
        if (that.mdChanged) {
          return 1;
        } else {
          return null;
        }
      }
    },
    // ---------- <<<<<<<<<<< 文章未保存离开时提示 uiAction  --------

    // ---------- prepareData uiAction >>>>>>>>>> --------
    async getUrlObj(){
      const urlObj = new URLSearchParams(location.search.substring(1));
      this.articleId = urlObj.get('articleId');
    },
    // ---------- <<<<<<<<<<< prepareData uiAction  --------

    // ---------- 获取数据 uiAction >>>>>>>>>> --------
    async getArticleData() {
      if(this.articleId){
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'articleEdit',
              actionId: 'selectArticleWithCategory',
              actionData: {
                articleId: this.articleId
              },
            }
          }
        });
        this.editItem = result.data.appData.resultData;
      }
    },
    // ---------- <<<<<<<<<<< 获取数据 uiAction  --------

    // ---------- 删除数据 uiAction >>>>>>>>>>>> --------
    async confirmDeleteItemDialog() {
      if (await window.confirmDialog({title: "<$ constantUiMap.common.recycle $>", content: "<$ constantUiMap.article.recyclingConfirmation $>？"}) === false) {
        throw new Error("[confirmDeleteItemDialog] 否");
      }
    },
    async doDeleteItem() {
      await window.vtoast.loading("<$ constantUiMap.article.recyclingArticles $>");
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'articleEdit',
            actionId: 'deletedArticle',
            actionData: { articleId: this.articleId }
          }
        }
      });
      await window.vtoast.success("<$ constantUiMap.article.recyclingArticlesSuccess $>");
    },
    // ---------- <<<<<<<<<<< 删除数据 uiAction  --------

    // ---------- 恢复数据 uiAction >>>>>>>>>>>> --------
    async confirmRestoreItemDialog() {
      if (await window.confirmDialog({title: "<$ constantUiMap.common.recover $>", content: "<$ constantUiMap.article.restoreArticleConfirm $>？"}) === false) {
        throw new Error("[confirmRestoreItemDialog] 否");
      }
    },
    async doRestoreItem() {
      await window.vtoast.loading("<$ constantUiMap.article.recoverArticle $>");
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'articleManagement',
            actionId: 'restoreArticle',
            actionData: { articleId: this.articleId }
          }
        }
      });
      await window.vtoast.success("<$ constantUiMap.article.recoverArticlesSuccessfully $>");
    },
    // ---------- <<<<<<<<<<< 恢复数据 uiAction  --------

    // ---------- 保存数据 uiAction >>>>>>>>>>>> --------
    async saveInfo() {
      if (!this.editItem.articleTagList) { this.editItem.articleTagList = ''; }
      const parts = this.editItem.articleTagList.replace(/，/g, ',').split(',')
      this.editItem.articleTagList = parts.map(item => item.trim()).join(',')
      this.editItem.articlePublishTime = dayjs(this.editItem.articlePublishTime).format();
      if (this.computedEditItem.id) {
        this.doUiAction('updateItem');
      } else {
        this.doUiAction('insertItem');
      }
    },
    // ---------- <<<<<<<<<<< 保存数据 uiAction  --------

    // ---------- 新增文章 uiAction >>>>>>>>>>>> --------
    async insertItem() {
      const { id, articleList, categoryName, ...saveInfo } = this.computedEditItem;
      await window.vtoast.loading("新增文章");
      const result = await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'articleEdit',
            actionId: 'jhInsertItem',
            actionData: saveInfo
          }
        }
      });
      await window.vtoast.success("新增文章成功");
      this.newArticleId = result.data.appData.resultData.rows[0];
    },
    // ---------- <<<<<<<<<<< 新增文章 uiAction  --------

    // ---------- 更新文章 uiAction >>>>>>>>>>>> --------
    async updateItem() {
      const { id, articleList, categoryName, ...saveInfo } = this.computedEditItem;
      await window.vtoast.loading("修改文章");
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'articleEdit',
            actionId: 'jhUpdateItem',
            actionData: saveInfo,
            where: {
              articleId: this.computedEditItem.articleId
            }
          }
        }
      })
      await window.vtoast.success("修改文章成功");
    },
    // ---------- <<<<<<<<<<< 更新文章 uiAction  --------

    clearImage() {
      this.editItem.articleCoverImage = null;
    },
    clearAudio() {
      this.editItem.articleAudioUrl = null;
    },
    clearVideo() {
      this.editItem.articleVideoUrl = null;
    },
    closeMaterialPicker() {
      this.isFileDialogShown = false;
    },
    async mdChangedFalse() {
      this.mdChanged = false;
    },
    async prepareValidate(){
      if (await this.articleIdCheck() === false) {
        window.vtoast.fail("请填写文章信息后,再点击上传文件!");
        throw new Error("[prepareValidate] false");
      }
    },
    async imagePicker() {
      this.materialType = 'image';
      this.writeBackType = 'attachment';
      this.isFileDialogShown = true;
    },
    async audioPicker() {
      this.materialType = 'audio';
      this.writeBackType = 'attachment';
      this.isFileDialogShown = true;
    },
    async videoPicker() {
      this.materialType = 'video';
      this.writeBackType = 'attachment';
      this.isFileDialogShown = true;
    },
    initEditorMd() {
      const that = this;
      this.$nextTick(() => {
        if (document.getElementById('editorMdContainer')) {
          document.getElementById('editorMdContainer').innerHTML = `<textarea style=\"display:none;\">${this.editItem['articleContent'] || ""}</textarea>`;
          that.editor = editormd('editorMdContainer', {
            // width  : "100%",
            // height : "100%",
            watch: false,
            saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
            path: '/<$ ctx.app.config.appId $>/public/plugins/editor.md/lib/',
            toolbarIcons: that.toolbarIcons,
            toolbarIconsClass: {
              imageUpload: 'fa-image',
              audioUpload: 'fa-file-audio-o',
              videoUpload: 'fa-youtube-play',
              attachmentUpload: 'fa-upload',
            },
            toolbarIconTexts: {
              toggle: "<i class='fa fa-expand' name='toggle' unselectable='on' style='display: inline-block;'></i><span class='ml-1'>收缩</span>",  // 如果没有图标，则可以这样直接插入内容，可以是字符串或HTML标签
              articleQuery: "<i class='fa fa-table' name='toggle' unselectable='on' style='display: inline-block;'></i><span class='ml-1'>列表</span>",  // 如果没有图标，则可以这样直接插入内容，可以是字符串或HTML标签
            },
            toolbarHandlers: {
              imageUpload: function (cm, icon, cursor, selection) {
                that.openImageUploadDrawer();
              },
              audioUpload: function (cm, icon, cursor, selection) {
                that.openAudioUploadDrawer();
              },
              videoUpload: function (cm, icon, cursor, selection) {
                that.openVideoUploadDrawer();
              },
              attachmentUpload: function (cm, icon, cursor, selection) {
                that.openAttachmentUploadDrawer();
              },
              toggle: function (cm, icon, cursor, selection) {
                cm.replaceSelection(`\n[jh-toggle title=\"title\" default-open=\"true\"]\n请输入内容\n[/jh-toggle]\n`);
              },
              articleQuery: function (cm, icon, cursor, selection) {
                cm.replaceSelection("\n[jh-article-query]\n" +
                    "{\n" +
                    " \"tableName\": \"数据表名称\",\n" +
                    " \"where\": \"where 字段名 = 字段值\",\n" +
                    " \"queryType\": \"order\",\n" +
                    " \"orderBy\": \"order by 字段名 asc\",\n" +
                    " \"limit\": 20\n" +
                    "}" +
                    "\n[/jh-article-query]\n");
              }
            },
            lang: {
              toolbar: {
                toggle: "展开收起",
                column: "横向排列",  // 自定义按钮的提示文本，即title属性
                articleQuery: "数据列表",
              }
            },
            onchange: function () {
              that.mdChanged = true;
              that.editItem.articleContent = this.getMarkdown();
              that.editItem.articleContentForSeo = this.getPreviewedHTML2();
            },
          });
        } else {
          requestAnimationFrame(() => {
            this.initEditorMd();
          })
        }
      })
    },
    // 添加图片
    async openImageUploadDrawer() {
      if (await this.articleIdCheck()) {
        this.materialType = 'image';
        this.writeBackType = 'editor';
        this.isFileDialogShown = true;
      }
    },
    // 添加音频
    async openAudioUploadDrawer() {
      if (await this.articleIdCheck()) {
        this.materialType = 'audio';
        this.writeBackType = 'editor';
        this.isFileDialogShown = true;
      }
    },
    // 添加视频
    async openVideoUploadDrawer() {
      if (await this.articleIdCheck()) {
        this.materialType = 'video';
        this.writeBackType = 'editor';
        this.isFileDialogShown = true;
      }
    },
    // 添加附件
    async openAttachmentUploadDrawer() {
      if (await this.articleIdCheck()) {
        this.materialType = 'attachment';
        this.writeBackType = 'editor';
        this.isFileDialogShown = true;
      }
    },
    
    async articleIdCheck() {
      if (!this.articleId) {
        await this.doUiAction('insertItem')
        return true;
      }
      return true;
    },

   
    // 保存并预览
    async saveInfoAndPreview() {
      this.doUiAction('saveInfo');
      window.location.href = `/${window.appInfo.appId}/page/article?id=${this.computedEditItem.articleId}`;
    },
    // 表单验证
    async prepareFormValidate() {
      if (await this.$refs.form.validate() === false) {
        throw new Error("[prepareFormValidate] false");
      }
    },
   
    // 获取新文章
    async getNewArticle(){
      const { rows } = (await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'articleEdit',
            actionId: 'selectItemList',
            actionData: {},
            where: { id: this.newArticleId },
          }
        }
      })).data.appData.resultData;
      const newArticle = rows[0];
      const { articleId, articleTitle } = newArticle
      this.articleId = articleId;
      this.editItem = newArticle;
    },
   
    async refreshPage(){
      const newUrl = `/${window.appInfo.appId}/page/articleEdit?articleId=${this.computedEditItem.articleId}&title=${this.computedEditItem.articleTitle}`;
      history.pushState({}, null, newUrl);
    },
    async useMaterial({ path }) {
      let filename, downloadPath = null;
      if (this.materialType === 'image') {
        const resultData = (await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'articleEdit',
              actionId: 'useMaterial',
              actionData: {
                articleId: this.articleId,
                path,
              },
            }
          }
        })).data.appData.resultData;
        filename = resultData.filename;
        downloadPath = resultData.downloadPath;
      } else {
        downloadPath = `/materialRepo${path}`;
        filename = path.substring(path.lastIndexOf('/')+1);
      }

      this.isFileDialogShown = false;
      if (this.writeBackType === 'editor') {
        switch (this.materialType) {
          case 'image':
            if (downloadPath) {
              this.editor.insertValue(`\n![${filename}](/upload${downloadPath})`);
            }
            break;
          case 'audio':
            if (downloadPath) {
              this.editor.insertValue(`\n![=audio](/upload${downloadPath})`);
            }
            break;
          case 'video':
            if (downloadPath) {
              this.editor.insertValue(`\n![=video](/upload${downloadPath})`);
            }
            break;
          case 'attachment':
            if (downloadPath) {
              // attachment如何渲染
              this.editor.insertValue(`\n[${filename}](/upload${downloadPath})`);
            }
            break;
        }
      } else {
        switch (this.materialType) {
          case 'image':
            if (downloadPath) {
              this.editItem.articleCoverImage = downloadPath
            }
            break;
          case 'audio':
            if (downloadPath) {
              this.editItem.articleAudioUrl = downloadPath
            }
            break;
          case 'video':
            if (downloadPath) {
              this.editItem.articleVideoUrl = downloadPath
            }
            break;
          case 'attachment':
            // attachment如何渲染
            break;
        }
      }
    }
  }
})
</script>

<style scoped>
  :root {
    --border-color: #eff2f5;
  }
  .v-dialog--fullscreen .v-sheet {
    height: auto;
    position: relative;
    background: #fff;
    display: block;
  }
  .editormd, .CodeMirror-gutters, .editormd-toolbar, .editormd .CodeMirror, .editormd-menu > li.divider, .editormd-menu > li > a:hover, .editormd-menu > li > a.active{
    border-color: var(--border-color) !important;
  }
  .CodeMirror-gutter{
    background-color: #fff;
  }
  .CodeMirror-scroll{
    overflow-x: hidden !important;
  }
  .editormd-dialog-close{
    color: #3F4254 !important;
  }
  .editormd-preview-container ol.linenums li, .editormd-html-preview ol.linenums li {
      list-style-type: none;
  }
  .editormd-preview-container ol.linenums, .editormd-html-preview ol.linenums {
      color: #999;
      padding-left: 0;
  }
</style>
{% endblock %}
